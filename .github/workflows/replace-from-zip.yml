name: Replace Repo from Zip

on:
  workflow_dispatch:
    inputs:
      zip_filename:
        description: "Name of the zip file (uploaded to repo root)"
        required: true
        default: "Genetics-behavior-overhaul.zip"
      nested_folder:
        description: "Optional: nested folder name inside the zip (e.g., Genetics-main). Leave blank to auto-detect."
        required: false
        default: ""
      run_verify:
        description: "Run npm ci + npm run verify before committing"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
      commit_message:
        description: "Commit message"
        required: false
        default: "Replace repo contents from ZIP"

permissions:
  contents: write

concurrency:
  group: replace-from-zip
  cancel-in-progress: true

jobs:
  replace-from-zip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Uses your secret if present; otherwise falls back to the default token
          token: ${{ secrets.REPLACE_ZIP_TOKEN || github.token }}
          fetch-depth: 0

      - name: Validate ZIP exists
        run: |
          set -euo pipefail
          ZIP="${{ github.event.inputs.zip_filename }}"
          if [ ! -f "$ZIP" ]; then
            echo "::error::ZIP file '$ZIP' not found at repo root."
            echo "Repo root contents:"
            ls -la
            exit 1
          fi

      - name: Replace repo contents from ZIP (nested folder optional)
        run: |
          set -euo pipefail

          ZIP="${{ github.event.inputs.zip_filename }}"
          NESTED="${{ github.event.inputs.nested_folder }}"

          TMP="$(mktemp -d)"
          echo "Unzipping '$ZIP' to '$TMP'..."
          unzip -q "$ZIP" -d "$TMP"

          # Decide what directory inside the unzip is the "real" repo root.
          SRC="$TMP"

          if [ -n "${NESTED}" ]; then
            if [ ! -d "$TMP/$NESTED" ]; then
              echo "::error::nested_folder '$NESTED' was provided but not found inside the ZIP."
              echo "Top-level folders inside ZIP:"
              find "$TMP" -mindepth 1 -maxdepth 1 -type d -printf " - %f\n" || true
              exit 1
            fi
            SRC="$TMP/$NESTED"
          else
            # Auto-detect: if there's exactly one top-level directory (ignoring __MACOSX)
            # and no top-level files, assume that single directory is the repo root.
            mapfile -t TOP_DIRS < <(find "$TMP" -mindepth 1 -maxdepth 1 -type d ! -name "__MACOSX" -printf "%f\n" | sort)
            mapfile -t TOP_FILES < <(find "$TMP" -mindepth 1 -maxdepth 1 -type f -printf "%f\n" | sort)

            if [ "${#TOP_FILES[@]}" -eq 0 ] && [ "${#TOP_DIRS[@]}" -eq 1 ]; then
              SRC="$TMP/${TOP_DIRS[0]}"
            fi
          fi

          echo "Using source directory: $SRC"
          if [ ! -d "$SRC" ]; then
            echo "::error::Source directory '$SRC' does not exist."
            exit 1
          fi

          # Sync into repo root, preserving .git and the ZIP file itself.
          rsync -a --delete \
            --exclude='.git/' \
            --exclude="$ZIP" \
            "$SRC"/ ./

          rm -rf "$TMP"

      - name: Setup Node (if verify)
        if: ${{ github.event.inputs.run_verify == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Verify (if verify)
        if: ${{ github.event.inputs.run_verify == 'true' }}
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            npm ci
            npm run verify
          else
            echo "No package.json found; skipping npm verify."
          fi

      - name: Commit & push
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          MSG="${{ github.event.inputs.commit_message }}"
          git commit -m "$MSG"
          git push
