name: Replace repo from ZIP (flatten nested)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  replace:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install unzip + rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip rsync

      - name: Unzip into runner temp (NOT inside repo)
        env:
          ZIP_FILE: Genetics-improved.zip
        run: |
          set -euo pipefail
          test -f "$ZIP_FILE" || (echo "$ZIP_FILE not found at repo root" && ls -la && exit 1)

          EXTRACT_DIR="${RUNNER_TEMP}/zip_extract"
          rm -rf "$EXTRACT_DIR"
          mkdir -p "$EXTRACT_DIR"

          unzip -q "$ZIP_FILE" -d "$EXTRACT_DIR"
          echo "EXTRACT_DIR=$EXTRACT_DIR" >> "$GITHUB_ENV"

      - name: Determine source folder (handles nested-once like Genetics-main/)
        run: |
          set -euo pipefail
          D="$EXTRACT_DIR"
          TOP_DIRS=$(find "$D" -mindepth 1 -maxdepth 1 -type d | wc -l)
          TOP_FILES=$(find "$D" -mindepth 1 -maxdepth 1 -type f | wc -l)

          if [ "$TOP_DIRS" -eq 1 ] && [ "$TOP_FILES" -eq 0 ]; then
            SRC_DIR=$(find "$D" -mindepth 1 -maxdepth 1 -type d | head -n 1)
          else
            SRC_DIR="$D"
          fi

          echo "SRC_DIR=$SRC_DIR" >> "$GITHUB_ENV"
          echo "Using SRC_DIR=$SRC_DIR"

      - name: Replace repo contents (preserve this workflow file)
        run: |
          set -euo pipefail
          rsync -a --delete \
            --exclude=".git/" \
            --exclude=".github/workflows/replace-from-zip.yml" \
            "$SRC_DIR"/ "$GITHUB_WORKSPACE"/

      - name: Delete the ZIP from the repo after
        run: |
          set -euo pipefail
          rm -f "$GITHUB_WORKSPACE/Genetics-improved.zip"

      - name: Commit & push
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git add -A
          git commit -m "Replace repo contents from Genetics-improved.zip (flattened)"
          git push

          if [ "$TOP_DIR_COUNT" -eq 1 ] && [ "$TOP_FILE_COUNT" -eq 0 ]; then
            SRC_DIR=$(find _zip_extract -mindepth 1 -maxdepth 1 -type d | head -n 1)
          else
            SRC_DIR="_zip_extract"
          fi

          echo "SRC_DIR=$SRC_DIR" >> $GITHUB_ENV
          echo "Using source: $SRC_DIR"

      - name: Replace repo contents (preserve workflow file)
        run: |
          set -e
          # rsync --delete makes the repo root match the source exactly
          # Exclude .git and keep this workflow file so the run doesn't delete itself mid-flight.
          rsync -a --delete \
            --exclude=".git/" \
            --exclude=".github/workflows/replace-from-zip.yml" \
            "$SRC_DIR"/ ./

          # Optional: remove the zip after successful sync
          rm -f Genetics-improved.zip

      - name: Commit & push
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git add -A
          git commit -m "Replace repo contents from Genetics-improved.zip (flattened)"
          git push
