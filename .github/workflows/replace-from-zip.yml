name: Replace repo from ZIP (flatten nested)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  replace:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install unzip + rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip rsync

      - name: Unzip
        run: |
          test -f Genetics-improved.zip || (echo "Genetics-improved.zip not found at repo root" && exit 1)
          rm -rf _zip_extract
          mkdir -p _zip_extract
          unzip -q Genetics-improved.zip -d _zip_extract

      - name: Determine source folder (handle nested-once)
        run: |
          set -e
          # If the ZIP contains exactly one top-level folder, use that folder as the source.
          # Otherwise, use the extract root.
          TOP_DIR_COUNT=$(find _zip_extract -mindepth 1 -maxdepth 1 -type d | wc -l)
          TOP_FILE_COUNT=$(find _zip_extract -mindepth 1 -maxdepth 1 -type f | wc -l)

          if [ "$TOP_DIR_COUNT" -eq 1 ] && [ "$TOP_FILE_COUNT" -eq 0 ]; then
            SRC_DIR=$(find _zip_extract -mindepth 1 -maxdepth 1 -type d | head -n 1)
          else
            SRC_DIR="_zip_extract"
          fi

          echo "SRC_DIR=$SRC_DIR" >> $GITHUB_ENV
          echo "Using source: $SRC_DIR"

      - name: Replace repo contents (preserve workflow file)
        run: |
          set -e
          # rsync --delete makes the repo root match the source exactly
          # Exclude .git and keep this workflow file so the run doesn't delete itself mid-flight.
          rsync -a --delete \
            --exclude=".git/" \
            --exclude=".github/workflows/replace-from-zip.yml" \
            "$SRC_DIR"/ ./

          # Optional: remove the zip after successful sync
          rm -f Genetics-improved.zip

      - name: Commit & push
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git add -A
          git commit -m "Replace repo contents from Genetics-improved.zip (flattened)"
          git push
